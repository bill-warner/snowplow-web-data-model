# Snowplow web model

## Introduction

This is a fork of the snowplow web data model repo with suggested improvements to the model.

## Improvements

The improvements fall into two groups:
- [Creation of new models](#creation-of-new-models)
- [Additions to existing models](#additions-to-existing-models)
  - Additional dimensions/facts
  - Performance tuning
  
In addition to the changes below, we could update the models to run incrementally. This would both improve performance and cost. I chose not to do this however as there is already a pre-existing version of incremental models. 

### Creation of new models
#### [User Stitching](sql/01-user-stitching/00-user-stitching.sql)
This model maps `domain_userid` to `user_id`. This allows non logged in sessions to be attributed to a specific user, rather than to given cookie. It assumes after a logged in session for a given cookie (`domain_userid`), that every subsequent non logged in session is generated by the same user. This is valid until a new user logs in under the same cookie, at which point future, non logged in, sessions are attributed to the new user.
| Field                               | Type | Description                                                            | Example               |
| :---                                | :--- | :---                                                                   | :---                  |
| `domain_userid`                     |  text| User ID set by Snowplow using 1st party cookie | 'bc2e92ec6c204a14'   
| `user_id`               | text | Unique ID set by business        | 'jon.doe@email.com'                    |
| `valid_from`               | timestamp | Point at time in which assumed user_id is valid.         | '2015-07-20 10:35:22.441000'                   |
| `valid_to`               | timestamp | Point at time in which assumed user_id is invalid.        | '2015-07-22 12:23:00.00000'                    |

#### [Marketing Campaigns](sql/05-marketing-campaings/00-marketing-campaings.sql)
This model gives a high level view of marketing campaign performance such as:
- User acquisition
- Reactivation
- Retention
- Engagement. 

Ideally we would look to include cost data where available to give a more holistic view. 

| Field                | Type | Description                                                    | Example                                 |
| :---                 | :--- | :---                                                           | :---                                    |
| `marketing_medium`   | text | Type of traffic source                                         | 'cpc', 'affiliate', 'organic', 'social' |
| `marketing_source`   | text | The company / website where the traffic came from              | 'Google', 'Facebook'                    |
| `marketing_term`     | text | Any keywords associated with the referrer                       | 'new age tarot decks'                   |
| `marketing_content`  | text | The content of the ad. (Or an ID so that it can be looked up.) | '13894723'                              |
| `marketing_campaign` | text | The campaign ID                                                | 'diageo-123'                            |
| `marketing_click_id` | text | The click ID                                                   | 'ac3d8e459'                             |
| `marketing_network`  | text | The ad network to which the click ID belongs                   | 'DoubleClick'                           |
| `campaign_start`  | timestamp | Time at which the campaign launched                 | '2015-07-22 12:23:00.00000'                          |
| `campaign_days_active`  | int | Days since the campaign launched | 32                       |
| `users`  | integer | Number of users who engaged in the campaign. Users are defined by `stitched_user_id`.                 | 1253                          |
| `users_bounced`  | integer | Number of users who bounced i.e. only viewed one page in session and left immediately | 876                       |
| `users_engaged`  | integer | Number of users who engaged i.e. only viewed >2 pages and engaged for >59s | 435                       |
| `new_users`  | integer | Number of new users, defined by first session per `stitched_user_id` | 143                       |
| `reactivated_users`  | integer | Number of reactivated users. Reactivated is defined by >30 days since the users last session | 175                       |
| `repeat_users_within_30d`  | integer | Number of users who have a subsequent session within 30 days | 342                       |
| `sessions`  | integer | Count of unique sessions per campaign | 1253                       |
| `page_views`  | integer | Count of page views from session per campaign | 3543                       |
| `time_engaged_in_s`  | float | Total time engaged during sessions generated by each campaign | 495303                       |
| `sessions_length_in_s`  | float | Total session time per campaign  | 3539204                       |

#### [Page Performance](sql/06-page-performance/00-page-performance.sql)
This model gives a high level view of individual page performance. By aggregating to a page level we can analyse things such as:
- Popular pages
- Trending pages experiencing large growth in views
- Pages that cause users to churn
- Un-performant pages i.e. slow load times
- Popular content. Ideally we would want some kind of page content categorisation to achieve this.
- Device friendly content.

| Field                     | Type | Description                  | Example                                                                         |
| :---                      | :--- | :---                         | :---                                                                            |
| `first_page_url`          | text | The page URL	                | 'http://www.example.com'                                                        |
| `first_page_title`        | text | Web page title               | 'Using ChartIO to visualize and interrogate Snowplow data - Snowplow Analytics' |
| `sessions`        | int | Number of sessions in which the page was viewed               | 14320 |
| `first_viewed`        | date | First date on which the page was viewed               | '01-Jan-2020' |
| `days_since_first_view`        | integer | Days since the page was first viewed               | 174 |
| `total_loading_time_ms`        | integer | Total loading time for the page in ms               | 14 |
| `time_engaged_in_s`        | integer | Total time engaged in the page.                | 3424 |
| `horizontal_percentage_scrolled`        | float | Total % of the horizontal scroll within the page                | 143.2 |
| `vertical_percentage_scrolled`        | float | Total % of the vertical scroll within the page                | 143.2 |
| `page_views`        | integer | Number of times the page was viewed              | 304934 |
| `mobile_views`        | integer | Number of times the page was viewed on mobile              | 20483 |
| `page_views_current_7d`        | integer | Number of times the page was viewed in the current 7 day period            | 303394 |
| `page_views_previous_7d`        | integer | Number of times the page was viewed in the previous 7 day period              | 303284 |
| `page_views_current_30d`        | integer | Number of times the page was viewed in the current 30 day period            | 303394 |
| `page_views_previous_30d`        | integer | Number of times the page was viewed in the previous 30 day period              | 303284 |
| `page_views_current_6m`        | integer | Number of times the page was viewed in the current 6 month period            | 303394 |
| `page_views_previous_6m`        | integer | Number of times the page was viewed in the previous 6 month period              | 303284 |
| `users`        | integer | Number of unique users, based on `stitched_user_id`, to have visited the page             | 4342 |
| `users_bounced`        | integer | Number of unique users to have bounced from the page. Bounced is defined as 0s spent on the page.             | 345 |
| `users_engaged`        | integer | Number of unique users to have engaged with the page. Engaged is defined >= 30s spent on the page and >= 25% of the page vertically scrolled.             | 4342 |
| `first_page_views`        | integer | Number of times the page was viewed as the first page ever of a user. User is defined by `stitched_user_id`.        | 4342 |
| `first_page_in_session_views`        | integer | Number of times the page was viewed as the first page in the user's session        | 4342 |
| `last_page_in_session_views`        | integer | Number of times the page was viewed as the last page in the user's session        | 4342 |
| `page_view_in_session_index`        | integer | Sum of the page's index within a session        | 4342 |

### Additions to existing models

#### [Web Events](sql/02-page-views/01-events.sql)
- Improved readability by substituting in-line query with CTE.

#### [Web Events Time](sql/02-page-views/02-events-time.sql)
- Simplified `time_engaged_in_s` calc but maintain same output.
- Included additional filter `platform = web` to improve performance.

#### [Web Events Scroll Depth](sql/02-page-views/03-events-scroll-depth.sql)
- Included additional filter `platform = web` to improve performance.
- Option to consolidate events time + scroll depth into one model. This would avoid querying the atomic events table twice, as well as removing a subsequent join to the page views table. 

#### [Web Page Views](sql/02-page-views/06-page-views.sql)
- Joined in `user_stitching` table in order to add `stitched_user_id` to the model.
- Added `stitched_user_id_type` for the end consumer to understand the type of `stitched_user_id` that is being used i.e. actual user_id, assumed user_id or domain_id.
- Re-partitioned `page_view_index` on the `stitched_user_id` for a view across all devices.
- Renamed old `page_view_index`, partitioned on `domain_userid` to `domain_page_view_index`.
- Added `page_view_in_session_reverse_index` in order to quickly filter for the last page in a session i.e. where = 1 

#### [Sessions](sql/03-sessions/00-sessions.sql)
- Added `first_user_session` boolean field to indicate whether it a user's first session ever.
- Added `total_load_time` to sessions to quickly track page load times over time.
- Re-partitioned `session_index` on the `stitched_user_id` for a view across all devices.
- Renamed old `session_index`, partitioned on `domain_userid` to `domain_session_index`.
- Next & previous session timestamps added for use in other models.
- Added `session_completed` boolean flag. This is `FALSE` if they `session_end` is within 30 minutes of the latest ETL timestamp within the table. This allows for easy filtering of incomplete sessions which could skew analysis. 
- Last page visited in session details added.

#### [Users](sql/04-users/00-users.sql)
- Amended grain of the table, aggregating on `stitched_user_id` rather than `user_snowplow_domain_id`. This provides a better representation of a customer's profile, rather than a cookie specific profile.



## Copyright and license

The Snowplow web model is copyright 2016 Snowplow Analytics Ltd.

Licensed under the [Apache License, Version 2.0][license] (the "License");
you may not use this software except in compliance with the License.

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

[looker]: https://looker.com/
[license]: http://www.apache.org/licenses/LICENSE-2.0
